<!DOCTYPE html>
<html>

<head>
    <title>Tripathi Bioinformatics</title>
    <link rel="stylesheet" href="https://use.typekit.net/azy2ine.css">
    <link rel='stylesheet' href='/stylesheets/pipeline.css' />
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel='stylesheet' href='/stylesheets/dna-pipeline.css' />
</head>

<body>
    <!-- Toolbar -->
    <%- include('partials/toolbar') %>

    <div class="timeline_content">
        <h1>Recommended Pipeline</h1>
        <h3 style="color:black;">Edit your timeline if necessary:</h3>

        <form id="dnaPipelineForm" action="/running" method="post">
            <% Categories.forEach(category => { %>
                <button type="button" class="collapsible" onclick="toggleCollapsible('section_<%= category.title %>')">
                    <h3><%= category.title %></h3>
                </button>

                <div class="content" id="section_<%= category.title %>">
                    <% for (let j = 0; j < category.entries.length; j++) { %>
                        <% if (category.title === "File Processing" && infoSteps[j] === 0) { continue; } %>
                        <% let entry = Commands.get(category.entries[j]); %>
                        <% let parameters = Parameters.get(entry.serverCall); %>

                        <div>
                            <label>
                                <div style="display: flex;">
                                    <input type="range" min="0" max="1" step="1" value="<%= entry.isEnabled ? 1 : 0 %>" name="slider_<%= entry.serverCall %>">
                                    <h4 class="category_labels"><%= entry.title %></h4>
                                </div>
                            </label>

                            <% if (parameters.length === 0) { %>
                                </div>
                                <% continue; } %>

                            <div id="options_<%= entry.serverCall %>" class="options-container <%= entry.isEnabled ? '' : 'hidden' %>">
                                <% parameters.forEach(parameter => { %>
                                    <div style="display: flex;">
                                        <label for="<%= parameter.title %>"><%= parameter.title %>:</label>
                                        <% if (parameter.type === "number") { %>
                                            <input class="option_input" type="number" id="<%= parameter.title %>" value="<%= parameter.value %>">
                                        <% } else if (parameter.type === "checkbox") { %>
                                            <input class="option_input" type="checkbox" id="<%= parameter.title %>" <% if (parameter.value) { %>checked<% } %>>
                                        <% } else if (parameter.type === "upload") { %>
                                            <input class="option_input" type="file" id="<%= parameter.title %>">
                                            <button type="button" onclick="uploadParameterFile('<%= parameter.title %>')"></button>
                                        <% } else if (parameter.type === "text") { %>
                                            <input class="option_input" type="text" id="<%= parameter.title %>" value="<%= parameter.value %>">
                                        <% } else { %>
                                            <select class="option_input" id="<%= parameter.title %>">
                                                <% parameter.options.forEach(option => { %>
                                                    <option value="<%= option %>" <% if (option === parameter.value) { %>selected<% } %>><%= option %></option>
                                                <% }) %>
                                            </select>
                                        <% } %>
                                    </div>
                                <% }) %>
                                <button type="button" class="save-btn" onclick="saveButton('<%= entry.serverCall %>')">Save</button>
                            </div>

                            <div id="options_display_<%= entry.serverCall %>" class="options-display hidden">
                                <% parameters.forEach(parameter => { %>
                                    <div style="display: flex;">
                                        <p style="color: #b985d9;"><%= parameter.title %>:</p>
                                        <p style="margin-left: 1rem;" id="option_<%= parameter.title %>_display"></p>
                                    </div>
                                <% }) %>
                                <button type="button" onclick="editButton('<%= entry.serverCall %>')" class="edit-btn">Edit</button>
                            </div>
                        </div>
                    <% } %>
                </div>
            <% }) %>

            <%- '<script>' %>
                const form = document.getElementById('dnaPipelineForm');
        
                let Commands = new Map(JSON.parse('<%- JSON.stringify(Array.from(Commands.entries())) %>'));
                let Parameters = new Map(JSON.parse('<%- JSON.stringify(Array.from(Parameters.entries())) %>'));
        
                function saveButton(entryTag) {
                    let parameters = Parameters.get(entryTag);
                    for (let parameter of parameters) {
                        let optionInput = document.getElementById(parameter.title);
                        let optionDisplayTag = document.getElementById('option_' + parameter.title + '_display');
                        let newValue;
                        switch (parameter.type) {
                            case "number":
                            case "text":
                                newValue = optionInput.value;
                                break;
                            case "checkbox":
                                newValue = optionInput.checked;
                                break;
                            case "select":
                                newValue = optionInput.value;
                                break;
                            case "upload":
                                continue;
                            default:
                                console.log("Not a valid input type");
                        }
                        if (newValue === "") {
                            // no value was entered, dip
                            continue;
                        }
                        parameter.value = newValue;
                        optionDisplayTag.innerText = newValue.toString();
                    };
                    Parameters.set(entryTag, parameters);
        
                    let optionsDiv = document.getElementById('options_' + entryTag);
                    let displayDiv = document.getElementById('options_display_' + entryTag);
                    optionsDiv?.classList.add('hidden');
                    displayDiv?.classList.remove('hidden');
                }
        
                function editButton(entryTag) {
                    let optionsDiv = document.getElementById('options_' + entryTag);
                    let displayDiv = document.getElementById('options_display_' + entryTag);
                    displayDiv?.classList.add('hidden');
                    optionsDiv?.classList.remove('hidden');
                }
        
                form.addEventListener('change', function (event) {
                    if (event.target.type === 'range') {
                        const sliderName = event.target.name;
                        const tag = sliderName.split('_')[1];
                        changingEntry = Commands.get(tag);
                        Commands.set(tag, {title: changingEntry.title, isEnabled: (event.target.value == 1), serverCall: changingEntry.serverCall});
        
                        let optionsDiv = document.getElementById('options_' + tag);
                        let displayDiv = document.getElementById('options_display_' + tag);
        
                        if (Commands.get(tag).isEnabled) {
                            displayDiv?.classList.remove('hidden');
                        } else {
                            optionsDiv?.classList.add('hidden');
                            displayDiv?.classList.add('hidden');
                        }
                    }
                });
        
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    document.querySelector('[name="Commands"]').value = JSON.stringify(Array.from(Commands.entries()));
                    document.querySelector('[name="Parameters"]').value = JSON.stringify(Array.from(Parameters.entries()));

                    form.submit();
                });
        
                function toggleCollapsible(sectionId) {
                    const collapsibleContent = document.getElementById(sectionId);
                    collapsibleContent.classList.toggle('active');
                }
                <%- '</script>' %>

            <input type="hidden" name="Commands">
            <input type="hidden" name="Parameters">
            <button class="pipeline_continue_button"><h3 style="color: black">Continue</h3></button>
        </form>
    </div>
</body>

</html>
